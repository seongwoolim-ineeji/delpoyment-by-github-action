name: ci

on:
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  lint-test-in-docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Build dev image
        run: docker build -f backend/api/Dockerfile-dev -t backend-dev:ci ./backend

      - name: Ruff lint (in container)
        run: |
          docker run --rm \
            -v "${{ github.workspace }}/backend:/workspace" \
            -w /workspace \
            backend-dev:ci \
            pixi run ruff check .

      - name: Ruff format check (in container)
        run: |
          docker run --rm \
            -v "${{ github.workspace }}/backend:/workspace" \
            -w /workspace \
            backend-dev:ci \
            pixi run ruff format --check .

      - name: Pytest (in container)
        run: |
          docker run --rm \
            -v "${{ github.workspace }}/backend:/workspace" \
            -w /workspace \
            backend-dev:ci \
            pixi run pytest -q